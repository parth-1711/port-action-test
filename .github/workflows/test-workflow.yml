name: Register CI Job in Port Catalog

on:
  workflow_dispatch:
  
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed

jobs:
  register-ci-job:
    runs-on: ubuntu-latest
    steps:
      - name: Register CI Job in Port
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: UPSERT
          identifier: ${{ github.workflow }}-${{ github.run_id }}
          blueprint: ci-job
          icon: "Server"
          properties: |
            {
              "jobName": "${{ github.workflow }}",
              "status": "${{ job.status }}",
              "duration": "${{ steps.duration.outputs.time }}",
              "runId": "${{ github.run_id }}",
              "commitSha": "${{ github.sha }}",
              "repository": "${{ github.repository }}"
            }
