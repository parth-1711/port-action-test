# name: Create ServiceNow Change with Tasks (from Port)

# on:
#   workflow_dispatch:
#     inputs:
#       short_description:
#         description: "Change Summary"
#         required: true
#         type: string
#       description:
#         description: "Description"
#         required: true
#         type: string
#       assignment_group:
#         description: "Assignment Group sys_id"
#         required: true
#         type: string
#       priority:
#         description: "Priority (1–5)"
#         required: true
#         type: string
#       planned_start_date:
#         description: "Planned Start (YYYY-MM-DD HH:MM:SS)"
#         required: false
#         type: string
#       planned_end_date:
#         description: "Planned End (YYYY-MM-DD HH:MM:SS)"
#         required: false
#         type: string
#       # Port will pass a JSON string like: ["Task A","Task B"]
#       task_descriptions:
#         description: "JSON array of task descriptions"
#         required: false
#         type: string
#       # Port will pass runId here so we can reference it if needed
#       port_run_id:
#         description: "Port run id (opaque)"
#         required: false
#         type: string

# jobs:
#   create-change-and-tasks:
#     runs-on: ubuntu-latest
#     permissions:
#       contents: read

#     env:
#       SN_INSTANCE: ${{ secrets.SERVICENOW_INSTANCE_URL }}   # e.g. https://dev296188.service-now.com
#       SN_AUTH:     ${{ secrets.SERVICENOW_API_TOKEN }}       # base64(username:password)

#     outputs:
#       change_number: ${{ steps.create_change.outputs.change_number }}
#       change_sys_id: ${{ steps.create_change.outputs.change_sys_id }}

#     steps:
#       - name: Validate inputs
#         run: |
#           echo "short_description=${{ inputs.short_description }}"
#           echo "assignment_group=${{ inputs.assignment_group }}"
#           echo "priority=${{ inputs.priority }}"
#           echo "planned_start_date=${{ inputs.planned_start_date }}"
#           echo "planned_end_date=${{ inputs.planned_end_date }}"
#           echo "task_descriptions=${{ inputs.task_descriptions }}"

#       - name: Create Change Request (ServiceNow)
#         id: create_change
#         shell: bash
#         run: |
#           set -euo pipefail
      
#           payload=$(jq -n --arg sd   "${{ inputs.short_description }}" \
#                          --arg desc "${{ inputs.description }}" \
#                          --arg ag   "${{ inputs.assignment_group }}" \
#                          --arg prio "${{ inputs.priority }}" \
#                          --arg start "${{ inputs.planned_start_date }}" \
#                          --arg end   "${{ inputs.planned_end_date }}" '
#             {
#               short_description: $sd,
#               description:       $desc,
#               assignment_group:  $ag,
#               priority:          $prio
#             }
#             + ( if ($start|length) > 0 then {start_date: $start} else {} end )
#             + ( if ($end  |length) > 0 then {end_date:  $end } else {} end )
#           ')
      
#           echo "Payload to ServiceNow:"
#           echo "$payload" | jq .
      
#           http_code=$(curl -sS -o resp.json -w "%{http_code}" \
#             -H "Authorization: Basic ${SN_AUTH}" \
#             -H "Content-Type: application/json" \
#             "${SN_INSTANCE}/api/now/table/change_request?sysparm_input_display_value=true" \
#             --data "${payload}")
      
#           if [[ "$http_code" != "200" && "$http_code" != "201" ]]; then
#             echo "::error title=ServiceNow::Failed to create change (HTTP ${http_code})"
#             cat resp.json || true
#             exit 1
#           fi
      
#           change_sys_id=$(jq -r '.result.sys_id'  resp.json)
#           change_number=$(jq -r '.result.number'  resp.json)
      
#           echo "change_sys_id=${change_sys_id}" >> "$GITHUB_OUTPUT"
#           echo "change_number=${change_number}" >> "$GITHUB_OUTPUT"
      
#           {
#             echo "### Created Change"
#             echo "- **Number**: ${change_number}"
#             echo "- **sys_id**: \`${change_sys_id}\`"
#           } >> "$GITHUB_STEP_SUMMARY"
#       - name: Create Change Tasks (if any)
#         if: ${{ inputs.task_descriptions != '' }}
#         id: create_tasks
#         shell: bash
#         run: |
#           set -euo pipefail

#           # Parse the JSON array of task descriptions; also accept a comma-separated fallback.
#           RAW='${{ inputs.task_descriptions }}'
#           if jq -e . >/dev/null 2>&1 <<<"$RAW"; then
#             TASKS_JSON="$RAW"
#           else
#             IFS=, read -ra PARTS <<< "$RAW"
#             TASKS_JSON=$(printf '%s\n' "${PARTS[@]}" | jq -Rsc 'split("\n") | map(select(length>0))')
#           fi

#           count=$(jq 'length' <<< "$TASKS_JSON")
#           if [[ "$count" -eq 0 ]]; then
#             echo "No tasks to create."
#             exit 0
#           fi

#           echo "Creating $count task(s)..."
#           CREATED=""

#           for t in $(jq -r '.[]' <<< "$TASKS_JSON" | jq -R .); do
#             task_desc=$(jq -r . <<< "$t")

#             task_payload=$(jq -n --arg sd "$task_desc" --arg cr "${{ steps.create_change.outputs.change_sys_id }}" '
#               { short_description: $sd, change_request: $cr }
#             ')

#             http_code=$(curl -sS -o task.json -w "%{http_code}" \
#               -H "Authorization: Basic ${SN_AUTH}" \
#               -H "Content-Type: application/json" \
#               "${SN_INSTANCE}/api/now/table/change_task?sysparm_input_display_value=true" \
#               --data "${task_payload}")

#             if [[ "$http_code" != "200" && "$http_code" != "201" ]]; then
#               echo "::error title=ServiceNow::Failed to create change_task (HTTP ${http_code})"
#               cat task.json || true
#               exit 1
#             fi

#             task_number=$(jq -r '.result.number' task.json)
#             CREATED+="- ${task_number}: ${task_desc}\n"
#           done

#           {
#             echo "### Created Tasks"
#             echo -e "$CREATED"
#           } >> "$GITHUB_STEP_SUMMARY"

#       - name: Final summary
#         run: |
#           echo "Change: ${{ steps.create_change.outputs.change_number }} (sys_id=${{ steps.create_change.outputs.change_sys_id }})" >> "$GITHUB_STEP_SUMMARY"

name: Create ServiceNow Change with Tasks (from Port)

on:
  workflow_dispatch:
    inputs:
      short_description:
        description: "Change Summary"
        required: true
        type: string
      description:
        description: "Description"
        required: true
        type: string
      assignment_group:
        description: "Assignment Group sys_id"
        required: true
        type: string
      priority:
        description: "Priority (1–5)"
        required: true
        type: string
      planned_start_date:
        description: "Planned Start (YYYY-MM-DD HH:MM:SS)"
        required: false
        type: string
      planned_end_date:
        description: "Planned End (YYYY-MM-DD HH:MM:SS)"
        required: false
        type: string
      task_descriptions:
        description: "JSON array of task descriptions"
        required: false
        type: string
      port_run_id:
        description: "Port run id (opaque)"
        required: false
        type: string

jobs:
  create-change-and-tasks:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      # Optional if you later want to fetch GH raw logs programmatically:
      # actions: read

    env:
      SN_INSTANCE: ${{ secrets.SERVICENOW_INSTANCE_URL }}
      SN_AUTH:     ${{ secrets.SERVICENOW_API_TOKEN }}

      # Port defaults; can be overridden with a repo variable for US region
      PORT_BASE_URL: ${{ vars.PORT_BASE_URL }} # leave empty for EU
      PORT_RUN_ID:   ${{ inputs.port_run_id }}

    outputs:
      change_number: ${{ steps.create_change.outputs.change_number }}
      change_sys_id: ${{ steps.create_change.outputs.change_sys_id }}

    steps:
      - name: Checkout (for safety if we write helper files)
        uses: actions/checkout@v4

      # --- Port: get an access token & helper function ---
      - name: Port • Init (get token & write helper)
        if: ${{ env.PORT_RUN_ID != '' }}
        id: port_init
        shell: bash
        run: |
          set -euo pipefail
          BASE_URL="${PORT_BASE_URL:-https://api.port.io}"

          echo "Fetching Port access token from ${BASE_URL}..."
          TOKEN=$(curl -sS -X POST \
            -H "Content-Type: application/json" \
            -d "{\"clientId\":\"${{ secrets.PORT_CLIENT_ID }}\",\"clientSecret\":\"${{ secrets.PORT_CLIENT_SECRET }}\"}" \
            "${BASE_URL}/v1/auth/access_token" | jq -r '.accessToken')

          if [[ -z "${TOKEN}" || "${TOKEN}" == "null" ]]; then
            echo "::error::Failed to obtain Port access token"
            exit 1
          fi
          # persist for subsequent steps
          {
            echo "PORT_BASE_URL=${BASE_URL}"
            echo "PORT_TOKEN=${TOKEN}"
          } >> "$GITHUB_ENV"

          # write a tiny helper we can reuse
          cat > port_log.sh <<'EOF'
          #!/usr/bin/env bash
          set -euo pipefail
          base="${PORT_BASE_URL:-https://api.port.io}"
          run_id="${PORT_RUN_ID:-}"
          token="${PORT_TOKEN:-}"
          msg="${1:-}"
          term="${2:-}"      # optional: SUCCESS|FAILURE
          label="${3:-}"     # optional: status label

          if [[ -z "$run_id" || -z "$token" || -z "$msg" ]]; then
            echo "port_log: missing run_id/token/message" >&2
            exit 0 # no-op if not available
          fi

          # JSON-escape message safely (handles newlines)
          payload=$(jq -n --arg m "$msg" --arg t "$term" --arg l "$label" '
            {message:$m}
            + ( ($t|length)>0 ? {terminationStatus:$t} : {} )
            + ( ($l|length)>0 ? {statusLabel:$l} : {} )
          ')
          curl -sS -X POST \
            -H "Authorization: Bearer ${token}" \
            -H "Content-Type: application/json" \
            --data "$payload" \
            "${base}/v1/actions/runs/${run_id}/logs" >/dev/null
          EOF
          chmod +x port_log.sh

      - name: Port • Log start
        if: ${{ env.PORT_RUN_ID != '' }}
        shell: bash
        run: |
          ./port_log.sh "Run started in GitHub Actions
          Repo: $GITHUB_REPOSITORY
          Workflow: $GITHUB_WORKFLOW
          Run URL: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}
          " "" "STARTED"

      - name: Validate inputs
        run: |
          echo "short_description=${{ inputs.short_description }}"
          echo "assignment_group=${{ inputs.assignment_group }}"
          echo "priority=${{ inputs.priority }}"
          echo "planned_start_date=${{ inputs.planned_start_date }}"
          echo "planned_end_date=${{ inputs.planned_end_date }}"
          echo "task_descriptions=${{ inputs.task_descriptions }}"

      - name: Port • Log validated inputs
        if: ${{ env.PORT_RUN_ID != '' }}
        shell: bash
        run: |
          ./port_log.sh "Inputs validated:
          short_description='${{ inputs.short_description }}'
          priority='${{ inputs.priority }}'
          tasks_input_present=$([ -n '${{ inputs.task_descriptions }}' ] && echo yes || echo no)
          "

      - name: Create Change Request (ServiceNow)
        id: create_change
        shell: bash
        run: |
          set -euo pipefail
      
          payload=$(jq -n --arg sd   "${{ inputs.short_description }}" \
                         --arg desc "${{ inputs.description }}" \
                         --arg ag   "${{ inputs.assignment_group }}" \
                         --arg prio "${{ inputs.priority }}" \
                         --arg start "${{ inputs.planned_start_date }}" \
                         --arg end   "${{ inputs.planned_end_date }}" '
            {
              short_description: $sd,
              description:       $desc,
              assignment_group:  $ag,
              priority:          $prio
            }
            + ( if ($start|length) > 0 then {start_date: $start} else {} end )
            + ( if ($end  |length) > 0 then {end_date:  $end } else {} end )
          ')
      
          echo "Payload to ServiceNow:"
          echo "$payload" | jq .
      
          http_code=$(curl -sS -o resp.json -w "%{http_code}" \
            -H "Authorization: Basic ${SN_AUTH}" \
            -H "Content-Type: application/json" \
            "${SN_INSTANCE}/api/now/table/change_request?sysparm_input_display_value=true" \
            --data "${payload}")
      
          if [[ "$http_code" != "200" && "$http_code" != "201" ]]; then
            echo "::error title=ServiceNow::Failed to create change (HTTP ${http_code})"
            cat resp.json || true
            exit 1
          fi
      
          change_sys_id=$(jq -r '.result.sys_id'  resp.json)
          change_number=$(jq -r '.result.number'  resp.json)
      
          echo "change_sys_id=${change_sys_id}" >> "$GITHUB_OUTPUT"
          echo "change_number=${change_number}" >> "$GITHUB_OUTPUT"
      
          {
            echo "### Created Change"
            echo "- **Number**: ${change_number}"
            echo "- **sys_id**: \`${change_sys_id}\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Port • Log change created
        if: ${{ env.PORT_RUN_ID != '' }}
        shell: bash
        run: |
          ./port_log.sh "Created ServiceNow Change:
          number='${{ steps.create_change.outputs.change_number }}'
          sys_id='${{ steps.create_change.outputs.change_sys_id }}'
          " "" "CHANGE_CREATED"

      - name: Create Change Tasks (if any)
        if: ${{ inputs.task_descriptions != '' }}
        id: create_tasks
        shell: bash
        run: |
          set -euo pipefail
          RAW='${{ inputs.task_descriptions }}'
          if jq -e . >/dev/null 2>&1 <<<"$RAW"; then
            TASKS_JSON="$RAW"
          else
            IFS=, read -ra PARTS <<< "$RAW"
            TASKS_JSON=$(printf '%s\n' "${PARTS[@]}" | jq -Rsc 'split("\n") | map(select(length>0))')
          fi
          count=$(jq 'length' <<< "$TASKS_JSON")
          if [[ "$count" -eq 0 ]]; then
            echo "No tasks to create."
            echo "tasks_created=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "Creating $count task(s)..."
          CREATED=""
          for t in $(jq -r '.[]' <<< "$TASKS_JSON" | jq -R .); do
            task_desc=$(jq -r . <<< "$t")
            task_payload=$(jq -n --arg sd "$task_desc" --arg cr "${{ steps.create_change.outputs.change_sys_id }}" '
              { short_description: $sd, change_request: $cr }
            ')
            http_code=$(curl -sS -o task.json -w "%{http_code}" \
              -H "Authorization: Basic ${SN_AUTH}" \
              -H "Content-Type: application/json" \
              "${SN_INSTANCE}/api/now/table/change_task?sysparm_input_display_value=true" \
              --data "${task_payload}")
            if [[ "$http_code" != "200" && "$http_code" != "201" ]]; then
              echo "::error title=ServiceNow::Failed to create change_task (HTTP ${http_code})"
              cat task.json || true
              exit 1
            fi
            task_number=$(jq -r '.result.number' task.json)
            CREATED+="- ${task_number}: ${task_desc}\n"
          done
          {
            echo "### Created Tasks"
            echo -e "$CREATED"
          } >> "$GITHUB_STEP_SUMMARY"

          # Expose summary for later Port log
          echo "tasks_created=${count}" >> "$GITHUB_OUTPUT"
          printf "%b" "$CREATED" > tasks_summary.txt

      - name: Port • Log tasks created
        if: ${{ env.PORT_RUN_ID != '' && steps.create_tasks.outputs.tasks_created != '' }}
        shell: bash
        run: |
          SUMMARY=$(cat tasks_summary.txt || true)
          ./port_log.sh "Created ${{ steps.create_tasks.outputs.tasks_created }} task(s):\n${SUMMARY}"

      - name: Final summary
        run: |
          echo "Change: ${{ steps.create_change.outputs.change_number }} (sys_id=${{ steps.create_change.outputs.change_sys_id }})" >> "$GITHUB_STEP_SUMMARY"

      # --- Port: finalize run status (SUCCESS/FAILURE) ---
      - name: Port • Finalize status
        if: ${{ env.PORT_RUN_ID != '' && (success() || failure()) }}
        shell: bash
        run: |
          STATUS="SUCCESS"
          LABEL="COMPLETED"
          if [[ "${{ job.status }}" != "success" ]]; then
            STATUS="FAILURE"
            LABEL="FAILED"
          fi
          MSG="Run ${LABEL}
          Change: ${{ steps.create_change.outputs.change_number }} (sys_id=${{ steps.create_change.outputs.change_sys_id }})
          GH Run: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}
          "
          ./port_log.sh "$MSG" "$STATUS" "$LABEL"
