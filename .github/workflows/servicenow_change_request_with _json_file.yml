name: "Create ServiceNow Change + Tasks + attachment.json (from Port)"

on:
  workflow_dispatch:
    inputs:
      payload:
        description: "Port action payload as JSON string"
        required: true
        type: string
      port_run_id:
        description: "Port run id (opaque)"
        required: false
        type: string

jobs:
  create-change-and-tasks:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      SN_INSTANCE: ${{ secrets.SERVICENOW_INSTANCE_URL }}
      SN_AUTH: ${{ secrets.SERVICENOW_API_TOKEN }}
    outputs:
      change_number: ${{ steps.create_change.outputs.change_number }}
      change_sys_id: ${{ steps.create_change.outputs.change_sys_id }}
    steps:
      - name: Parse payload
        id: parse
        shell: bash
        run: |
          set -euo pipefail
          echo '${{ inputs.payload }}' > payload.json
          jq . payload.json
          # Extract values into GITHUB_OUTPUT as needed
          sd=$(jq -r '.short_description' payload.json)
          desc=$(jq -r '.description' payload.json)
          ag=$(jq -r '.assignment_group' payload.json)
          prio=$(jq -r '.priority' payload.json)
          start=$(jq -r '.planned_start_date // empty' payload.json)
          end=$(jq -r '.planned_end_date // empty' payload.json)
          echo "short_description=$sd" >> "$GITHUB_OUTPUT"
          echo "description=$desc" >> "$GITHUB_OUTPUT"
          echo "assignment_group=$ag" >> "$GITHUB_OUTPUT"
          echo "priority=$prio" >> "$GITHUB_OUTPUT"
          echo "planned_start_date=$start" >> "$GITHUB_OUTPUT"
          echo "planned_end_date=$end" >> "$GITHUB_OUTPUT"

      - name: Create Change Request (ServiceNow)
        id: create_change
        shell: bash
        run: |
          set -euo pipefail
          payload=$(jq -n \
            --arg sd "${{ steps.parse.outputs.short_description }}" \
            --arg desc "${{ steps.parse.outputs.description }}" \
            --arg ag "${{ steps.parse.outputs.assignment_group }}" \
            --arg prio "${{ steps.parse.outputs.priority }}" \
            --arg start "${{ steps.parse.outputs.planned_start_date }}" \
            --arg end "${{ steps.parse.outputs.planned_end_date }}" '
            { short_description: $sd, description: $desc, assignment_group: $ag, priority: $prio }
            + ( if ($start|length) > 0 then {start_date: $start} else {} end )
            + ( if ($end|length) > 0 then {end_date: $end} else {} end )
          ')
          echo "Payload to ServiceNow:"
          echo "$payload" | jq .
          http_code=$(curl -sS -o resp.json -w "%{http_code}" \
            -H "Authorization: Basic $SN_AUTH" \
            -H "Content-Type: application/json" \
            "$SN_INSTANCE/api/now/table/change_request?sysparm_input_display_value=true" \
            --data "$payload")
          if [[ "$http_code" != "200" && "$http_code" != "201" ]]; then
            echo "::error title=ServiceNow::Failed to create change (HTTP $http_code)"
            cat resp.json | jq . || true
            exit 1
          fi
          change_sys_id=$(jq -r '.result.sys_id' resp.json)
          change_number=$(jq -r '.result.number' resp.json)
          echo "change_sys_id=$change_sys_id" >> "$GITHUB_OUTPUT"
          echo "change_number=$change_number" >> "$GITHUB_OUTPUT"
          {
            echo "### Created Change"
            echo "- **Number**: $change_number"
            echo "- **sys_id**: \`$change_sys_id\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Attach attachment.json (if provided)
        id: attach_json
        shell: bash
        run: |
          set -euo pipefail
          ATTACH=$(jq -c '.attachment_json // empty' payload.json)
          if [[ -z "$ATTACH" || "$(jq -r 'type' <<<"$ATTACH")" != "object" || "$(jq -r 'length' <<<"$ATTACH")" -eq 0 ]]; then
            echo "No attachment_json provided. Skipping."
            exit 0
          fi
          echo "$ATTACH" | jq . > attachment.json
          http_code=$(curl -sS -o attach_resp.json -w "%{http_code}" \
            -H "Authorization: Basic $SN_AUTH" \
            -H "Accept: application/json" \
            -F "table_name=change_request" \
            -F "table_sys_id=${{ steps.create_change.outputs.change_sys_id }}" \
            -F "file=@attachment.json;type=application/json;filename=attachment.json" \
            "$SN_INSTANCE/api/now/attachment/upload")
          if [[ "$http_code" != "200" && "$http_code" != "201" ]]; then
            echo "::warning title=ServiceNow::Failed to upload attachment.json (HTTP $http_code)"
            cat attach_resp.json || true
            exit 0
          fi
          attachment_sys_id=$(jq -r '.result.sys_id // empty' attach_resp.json)
          echo "attachment_sys_id=$attachment_sys_id" >> "$GITHUB_OUTPUT"
          {
            echo "### Attachment"
            echo "- Uploaded **attachment.json** (sys_id: \`${attachment_sys_id:-unknown}\`)"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Create Change Tasks (if any)
        id: create_tasks
        shell: bash
        run: |
          set -euo pipefail
          count=$(jq '(.task_descriptions // []) | length' payload.json)
          if [[ "$count" -eq 0 ]]; then
            echo "No tasks to create."
            exit 0
          fi
          echo "Creating $count task(s)..."
          CREATED=""
          for task_desc in $(jq -r '.task_descriptions[]' payload.json | jq -R .); do
            td=$(jq -r . <<<"$task_desc")
            task_payload=$(jq -n --arg sd "$td" --arg cr "${{ steps.create_change.outputs.change_sys_id }}" \
              '{ short_description: $sd, change_request: $cr }')
            http_code=$(curl -sS -o task.json -w "%{http_code}" \
              -H "Authorization: Basic $SN_AUTH" \
              -H "Content-Type: application/json" \
              "$SN_INSTANCE/api/now/table/change_task?sysparm_input_display_value=true" \
              --data "$task_payload")
            if [[ "$http_code" != "200" && "$http_code" != "201" ]]; then
              echo "::error title=ServiceNow::Failed to create change_task (HTTP $http_code)"
              cat task.json || true
              exit 1
            fi
            task_number=$(jq -r '.result.number' task.json)
            CREATED+="- $task_number: $td\n"
          done
          {
            echo "### Created Tasks"
            echo -e "$CREATED"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Final summary
        shell: bash
        run: |
          echo "Change: ${{ steps.create_change.outputs.change_number }} (sys_id=${{ steps.create_change.outputs.change_sys_id }})" >> "$GITHUB_STEP_SUMMARY"

      - name: Send final log to Port
        if: ${{ inputs.port_run_id != '' }}
        shell: bash
        env:
          PORT_RUN_ID: ${{ inputs.port_run_id }}
          PORT_CLIENT_ID: ${{ secrets.CLIENT_ID }}
          PORT_CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          PORT_BASE_URL: ${{ vars.PORT_BASE_URL }}
        run: |
          set -euo pipefail
          BASE_URL="${PORT_BASE_URL:-https://api.port.io}"
          TOKEN_RESP=$(curl -sS -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg id "$PORT_CLIENT_ID" --arg sec "$PORT_CLIENT_SECRET" '{clientId:$id, clientSecret:$sec}')" \
            "$BASE_URL/v1/auth/access_token")
          TOKEN_BODY=$(sed '$d' <<< "$TOKEN_RESP")
          TOKEN_CODE=$(tail -n1 <<< "$TOKEN_RESP")
          TOKEN=$(jq -r '.accessToken // empty' <<< "$TOKEN_BODY")
          if [[ "$TOKEN_CODE" != "200" || -z "$TOKEN" ]]; then
            echo "::error::Failed to obtain Port access token (HTTP $TOKEN_CODE)"
            exit 1
          fi
          echo "::add-mask::$TOKEN"
          STATUS="SUCCESS"; LABEL="COMPLETED"
          if [[ "${{ job.status }}" != "success" ]]; then STATUS="FAILURE"; LABEL="FAILED"; fi
          MSG=$'Workflow completed\n'"Change: ${{ steps.create_change.outputs.change_number }} (sys_id=${{ steps.create_change.outputs.change_sys_id }})"$'\n'"GitHub Run: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          curl -sS -X POST \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            --data "$(jq -n --arg m "$MSG" --arg t "$STATUS" --arg l "$LABEL" '{message:$m, terminationStatus:$t, statusLabel:$l}')" \
            "$BASE_URL/v1/actions/runs/$PORT_RUN_ID/logs"
