name: Create ServiceNow Change with Tasks (from Port)

on:
  workflow_dispatch:
    inputs:
      short_description:
        description: "Change Summary"
        required: true
        type: string
      description:
        description: "Description"
        required: true
        type: string
      assignment_group:
        description: "Assignment Group sys_id"
        required: true
        type: string
      priority:
        description: "Priority (1–5)"
        required: true
        type: string
      planned_start_date:
        description: "Planned Start (YYYY-MM-DD HH:MM:SS)"
        required: false
        type: string
      planned_end_date:
        description: "Planned End (YYYY-MM-DD HH:MM:SS)"
        required: false
        type: string
      # Port will pass a JSON string like: ["Task A","Task B"]
      task_descriptions:
        description: "JSON array of task descriptions"
        required: false
        type: string
      # Port will pass runId here so we can reference it if needed
      port_run_id:
        description: "Port run id (opaque)"
        required: false
        type: string

jobs:
  create-change-and-tasks:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      SN_INSTANCE: ${{ secrets.SERVICENOW_INSTANCE_URL }}   # e.g. https://dev296188.service-now.com
      SN_AUTH:     ${{ secrets.SERVICENOW_API_TOKEN }}       # base64(username:password)

    outputs:
      change_number: ${{ steps.create_change.outputs.change_number }}
      change_sys_id: ${{ steps.create_change.outputs.change_sys_id }}

    steps:
      - name: Validate inputs
        run: |
          echo "short_description=${{ inputs.short_description }}"
          echo "assignment_group=${{ inputs.assignment_group }}"
          echo "priority=${{ inputs.priority }}"
          echo "planned_start_date=${{ inputs.planned_start_date }}"
          echo "planned_end_date=${{ inputs.planned_end_date }}"
          echo "task_descriptions=${{ inputs.task_descriptions }}"

      - name: Create Change Request (ServiceNow)
        id: create_change
        shell: bash
        run: |
          set -euo pipefail

          # NOTE: On the change_request table, the “Planned start/end” labels map to fields
          # start_date and end_date, while “Actual” map to work_start/work_end. [3](https://community.n8n.io/t/asynchronous-call-using-webhook/96275)
          payload=$(jq -n --arg sd "${{ inputs.short_description }}" \
                         --arg desc "${{ inputs.description }}" \
                         --arg ag "${{ inputs.assignment_group }}" \
                         --arg prio "${{ inputs.priority }}" \
                         --arg start "${{ inputs.planned_start_date }}" \
                         --arg end   "${{ inputs.planned_end_date }}" '
            {
              short_description: $sd,
              description: $desc,
              assignment_group: $ag,
              priority: $prio
            }
            + ( ($start|length)>0 ? {start_date: $start} : {} )
            + ( ($end  |length)>0 ? {end_date:  $end } : {} )
          ')

          # Table API POST to change_request; we pass sysparm_input_display_value=true so
          # choice/date inputs are handled as display values if provided as such. [4](https://www.servicenow.com/community/developer-forum/newbie-question-querying-change-request-table-with-rest-api/m-p/1483094)
          http_code=$(curl -sS -o resp.json -w "%{http_code}" \
            -H "Authorization: Basic ${SN_AUTH}" \
            -H "Content-Type: application/json" \
            "${SN_INSTANCE}/api/now/table/change_request?sysparm_input_display_value=true" \
            --data "${payload}")

          if [[ "$http_code" != "200" && "$http_code" != "201" ]]; then
            echo "::error title=ServiceNow::Failed to create change (HTTP ${http_code})"
            cat resp.json || true
            exit 1
          fi

          change_sys_id=$(jq -r '.result.sys_id' resp.json)
          change_number=$(jq -r '.result.number' resp.json)

          echo "change_sys_id=${change_sys_id}"   >> "$GITHUB_OUTPUT"
          echo "change_number=${change_number}"   >> "$GITHUB_OUTPUT"

          {
            echo "### Created Change"
            echo "- **Number**: ${change_number}"
            echo "- **sys_id**: \`${change_sys_id}\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Create Change Tasks (if any)
        if: ${{ inputs.task_descriptions != '' }}
        id: create_tasks
        shell: bash
        run: |
          set -euo pipefail

          # Parse the JSON array of task descriptions; also accept a comma-separated fallback.
          RAW='${{ inputs.task_descriptions }}'
          if jq -e . >/dev/null 2>&1 <<<"$RAW"; then
            TASKS_JSON="$RAW"
          else
            IFS=, read -ra PARTS <<< "$RAW"
            TASKS_JSON=$(printf '%s\n' "${PARTS[@]}" | jq -Rsc 'split("\n") | map(select(length>0))')
          fi

          count=$(jq 'length' <<< "$TASKS_JSON")
          if [[ "$count" -eq 0 ]]; then
            echo "No tasks to create."
            exit 0
          fi

          echo "Creating $count task(s)..."
          CREATED=""

          for t in $(jq -r '.[]' <<< "$TASKS_JSON" | jq -R .); do
            task_desc=$(jq -r . <<< "$t")

            task_payload=$(jq -n --arg sd "$task_desc" --arg cr "${{ steps.create_change.outputs.change_sys_id }}" '
              { short_description: $sd, change_request: $cr }
            ')

            http_code=$(curl -sS -o task.json -w "%{http_code}" \
              -H "Authorization: Basic ${SN_AUTH}" \
              -H "Content-Type: application/json" \
              "${SN_INSTANCE}/api/now/table/change_task?sysparm_input_display_value=true" \
              --data "${task_payload}")

            if [[ "$http_code" != "200" && "$http_code" != "201" ]]; then
              echo "::error title=ServiceNow::Failed to create change_task (HTTP ${http_code})"
              cat task.json || true
              exit 1
            fi

            task_number=$(jq -r '.result.number' task.json)
            CREATED+="- ${task_number}: ${task_desc}\n"
          done

          {
            echo "### Created Tasks"
            echo -e "$CREATED"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Final summary
        run: |
          echo "Change: ${{ steps.create_change.outputs.change_number }} (sys_id=${{ steps.create_change.outputs.change_sys_id }})" >> "$GITHUB_STEP_SUMMARY"
