name: SNOW Change Complete Trigger

on:
  repository_dispatch:
    types: [snow-change-tasks-complete]

jobs:
  run_on_cr_complete:
    runs-on: ubuntu-latest

    steps:
      - name: Print CR info
        run: echo "All tasks complete for Change Request ${{ github.event.client_payload.change_request }}"

      # Run your actual workflow steps here:
      - name: Run deployment
        run: |
          echo "Running deployment pipeline for CR ${{ github.event.client_payload.change_request }}"

      - name: Set ISO timestamp
        id: set_timestamp
        run: echo "iso_time=$(date -u '+%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT


      - name: Notify Port of completed change request
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.CLIENT_ID }}
          clientSecret: ${{ secrets.CLIENT_SECRET }}
          operation: UPSERT
          identifier: "cr-${{ github.event.client_payload.change_request }}-${{ github.run_id }}"
          blueprint: "change_request_event"
          properties: |
            {
              "changeRequestId": "${{ github.event.client_payload.change_request }}",
              "status": "COMPLETE",
              "workflowRunId": "${{ github.run_id }}",
              "runTimestamp": "${{ steps.set_timestamp.outputs.iso_time }}",
              "triggerSource": "ServiceNow",
              "repository": "${{ github.repository }}"
            }
